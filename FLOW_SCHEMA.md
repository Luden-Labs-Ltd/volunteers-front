# Схема флоу приложения

## Логика определения роли при авторизации

При авторизации по телефону + SMS система определяет роль пользователя следующим образом:

1. **Экран авторизации** (ввод телефона) - общий для всех
2. **После ввода SMS кода** система проверяет БД:
   - Если телефона **НЕТ в БД** → начинается регистрация волонтера (онбординг)
   - Если телефон есть с `role='needy'` → авторизация нуждающегося → экран нуждающегося
   - Если телефон есть с `role='volunteer'` → авторизация волонтера → экран волонтера

**Ключевой момент**: Нуждающийся не может зарегистрироваться сам - его создает админ. Поэтому если телефон есть в БД, система уже знает роль пользователя.

## Общий флоу от нуля до завершения

### 1. Инициализация системы (Админ)

```
[Админ]
  ↓
Регистрация (Email + Пароль)
  ↓
Создание программы(м)
  ↓
Добавление городов (название + координаты)
  ↓
[Система готова к работе]
```

### 2. Создание нуждающегося (Админ)

```
[Админ]
  ↓
Админ-панель → Управление нуждающимися
  ↓
Создание нуждающегося:
  - Телефон
  - Имя, Фамилия
  - Программа
  - Город
  - Адрес
  ↓
[Система отправляет SMS с кодом нуждающемуся]
  ↓
[Нуждающийся создан, статус: pending]
```

### 3. Авторизация (Определение роли)

**Важно**: Экран авторизации (ввод телефона) - общий для всех.

```
[Пользователь]
  ↓
Экран авторизации:
  - Ввод телефона
  ↓
[Отправка SMS кода]
  ↓
[Ввод SMS кода]
  ↓
[Проверка в БД: есть ли пользователь с таким телефоном?]
  ↓
    ┌─────────────────────┬─────────────────────┐
    ↓                     ↓                     ↓
[НЕТ в БД]        [Есть, role='needy']   [Есть, role='volunteer']
    ↓                     ↓                     ↓
[НОВАЯ               [Авторизация          [Авторизация
 РЕГИСТРАЦИЯ          нуждающегося]        волонтера]
 ВОЛОНТЕРА]              ↓                     ↓
    ↓              [Экран нуждающегося]  [Экран волонтера]
[Онбординг              ↓                     ↓
 волонтера]      [Доступ к созданию      [Список тасок]
    ↓              тасок]
[Раздел 3.1]
```

### 3.1. Регистрация волонтера (если телефона нет в БД)

```
[Новый пользователь]
  ↓
Авторизация (Телефон + SMS код)
  ↓
[Телефон не найден в БД → Начинается регистрация волонтера]
  ↓
Выбор программы
  ↓
Онбординг:
  - Выбор навыков
  - Выбор города
  ↓
Заполнение профиля:
  - Имя, Фамилия
  - Фото
  - О себе
  ↓
[Создается запись User с role='volunteer', статус: Pending]
  ↓
[Админ одобряет волонтера]
  ↓
[Статус: Approved → Волонтер может работать]
```

### 4. Первый вход нуждающегося (если телефон есть в БД с role='needy')

```
[Нуждающийся]
  ↓
Получает SMS с кодом (после создания админом)
  ↓
Экран авторизации:
  - Ввод телефона
  - Ввод SMS кода
  ↓
[Система находит пользователя с role='needy' в БД]
  ↓
[Авторизация успешна]
  ↓
[Показывается экран нуждающегося]
  ↓
[Доступ к созданию тасок]
```

### 5. Создание и выполнение таски

```
[Нуждающийся]
  ↓
Создание таски:
  - Ввод промпта для AI ("Нужно забрать ребенка из садика")
  - AI генерирует: название, описание, уточняющие вопросы
  - Ответ на вопросы (одно текстовое поле)
  - Выбор типа помощи
  - Указание количества баллов (например, 10)
  - Публикация таски
  ↓
[Статус таски: Active]
  ↓
[Push-уведомление волонтерам (подходящим по навыкам)]
  ↓
[Волонтер]
  ↓
Видит таску в списке (фильтр по навыкам и городу)
  ↓
Нажимает "Откликнуться"
  ↓
[Статус отклика: Pending]
  ↓
[Нуждающийся получает уведомление]
  ↓
[Нуждающийся]
  ↓
Просмотр откликов (список волонтеров)
  ↓
Одобрение волонтера
  ↓
[Статус таски: In Progress]
[Статус отклика: Approved]
  ↓
[Волонтер видит контакты нуждающегося (телефон, адрес)]
  ↓
[Волонтер]
  ↓
Выполнение таски
  ↓
Нажимает "Выполнено"
  ↓
[completedByVolunteer = true]
  ↓
[Нуждающийся]
  ↓
Нажимает "Выполнено"
  ↓
[completedByNeedy = true]
  ↓
[Оба подтвердили → Статус: Completed]
  ↓
[Начисление баллов волонтеру (количество из таски)]
  ↓
[Нуждающийся]
  ↓
Оставление отзыва:
  - Рейтинг (1-5 звезд)
  - Комментарий
  ↓
[Рейтинг волонтера обновляется (средний по всем отзывам)]
  ↓
[Таска исчезает из активных списков]
```

### 6. Управление баллами (Админ)

```
[Админ]
  ↓
Админ-панель → Управление баллами
  ↓
Просмотр баланса волонтеров
  ↓
Списание баллов (при обмене на билеты)
  ↓
[Баланс волонтера обновляется]
```

## Визуальная схема полного цикла

```
┌─────────────────────────────────────────────────────────────────┐
│                      ИНИЦИАЛИЗАЦИЯ СИСТЕМЫ                       │
└─────────────────────────────────────────────────────────────────┘
                              ↓
                    [Админ регистрируется]
                              ↓
                    [Создает программу]
                              ↓
                    [Добавляет города]
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                    УПРАВЛЕНИЕ ПОЛЬЗОВАТЕЛЯМИ                     │
└─────────────────────────────────────────────────────────────────┘
                              ↓
         ┌────────────────────┴────────────────────┐
         ↓                                         ↓
   [Создает нуждающегося]              [Одобряет волонтера]
         ↓                                         ↓
   [SMS нуждающемуся]                    [Волонтер: Approved]
         ↓
   [Нуждающийся авторизуется]
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                        РАБОТА С ТАСКАМИ                          │
└─────────────────────────────────────────────────────────────────┘
                              ↓
                    [Нуждающийся создает таску]
                              ↓
              (AI помощник: промпт → генерация)
                              ↓
                    [Таска: Active]
                              ↓
                    [Push волонтерам]
                              ↓
                    [Волонтер откликается]
                              ↓
                    [Нуждающийся одобряет]
                              ↓
                    [Таска: In Progress]
                              ↓
                    [Волонтер выполняет]
                              ↓
         ┌────────────────────┴────────────────────┐
         ↓                                         ↓
   [Волонтер: Выполнено]              [Нуждающийся: Выполнено]
         ↓                                         ↓
         └────────────────────┬────────────────────┘
                              ↓
                    [Таска: Completed]
                              ↓
                    [Начисление баллов]
                              ↓
                    [Отзыв о волонтере]
                              ↓
                    [Рейтинг обновляется]
```

## Детальная последовательность статусов

### Статус пользователя (Волонтер)

```
Pending → Approved → Blocked (опционально)
```

### Статус таски

```
Active → In Progress → Completed
              ↓
          Cancelled (может на любом этапе)
```

### Статус отклика

```
Pending → Approved → Rejected
```

### Подтверждение выполнения

```
completedByVolunteer: false → true
completedByNeedy: false → true
              ↓
    [Оба true] → Completed
```

## Ключевые точки взаимодействия

1. **Админ ↔ Нуждающийся**: Создание нуждающегося
2. **Админ ↔ Волонтер**: Одобрение регистрации
3. **Нуждающийся ↔ Волонтер**: Отклик и одобрение
4. **Нуждающийся ↔ Волонтер**: Подтверждение выполнения (двустороннее)
5. **Нуждающийся → Волонтер**: Отзыв и рейтинг
6. **Админ ↔ Волонтер**: Списание баллов
