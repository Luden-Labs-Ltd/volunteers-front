# Техническое задание: Волонтерское приложение

## 1. Общее описание проекта

Волонтерское приложение для связи волонтеров с нуждающимися семьями. Система позволяет нуждающимся создавать задачи (таски), а волонтерам находить и выполнять их в радиусе своего местоположения.

### Цель проекта
Создать платформу для координации волонтерской помощи с геймификацией, системой баллов и управлением со стороны ведущих программ.

---

## 2. Роли пользователей

### 2.1 Ведущий программы (Админ)
- Создание и управление программами (может быть несколько программ)
- Полный административный доступ в рамках своих программ
- Управление волонтерами программы (одобрение, блокировка, удаление)
- Управление нуждающимися программы
- Просмотр и редактирование всех тасок в программах
- Управление баллами волонтеров (списание)
- Управление городами (добавление, редактирование координат)
- Просмотр статистики и отчетов по программам

### 2.2 Волонтер
- Регистрация в программе с указанием навыков и локации (выбор города)
- Поиск тасок в радиусе 50км в рамках программы
- Отклик на таски
- Выполнение тасок
- Получение баллов за выполнение
- Просмотр рейтинга
- Профиль с фото и информацией
- Все действия происходят в рамках программы

### 2.3 Нуждающийся
- **Создается только ведущим программы** (человек не может самостоятельно зарегистрироваться как нуждающийся)
- Привязка к программе и городу (указывается ведущим программы)
- Создание неограниченного количества тасок в рамках программы
- Выбор типа помощи
- Просмотр откликнувшихся волонтеров
- Одобрение/отклонение волонтеров
- Оставление отзывов о волонтерах
- Все действия происходят в рамках программы

---

## 3. Функциональные требования

### 3.1 Авторизация и регистрация

#### 3.1.1 Авторизация

**Для волонтеров и нуждающихся:**
- **Метод**: Телефон + SMS код
- **Процесс**:
  1. Ввод номера телефона
  2. Отправка SMS с кодом подтверждения
  3. Ввод кода
  4. Авторизация в системе

**Для ведущего программы:**
- **Метод**: Email + Пароль
- **Процесс**:
  1. Ввод email и пароля
  2. Авторизация в админ-панели

#### 3.1.2 Регистрация волонтера
1. Авторизация по телефону
2. **Выбор программы** (если у ведущего несколько программ)
3. **Онбординг** (как в Wunderhart):
   - Выбор навыков (множественный выбор):
     - Электрик
     - Строитель
     - Водитель
     - Няня/Помощь с детьми
     - Покупки/Доставка
     - Уборка
     - Другое (с возможностью указать)
   - Выбор города из списка (админ указывает города с координатами)
4. Заполнение профиля:
   - Имя
   - Фамилия
   - Фотография
   - Информация о себе (текстовое поле)
5. Статус: **Pending** (ожидает одобрения ведущего программы)
6. После одобрения - доступ к функционалу в рамках программы

#### 3.1.3 Создание нуждающегося
**Важно**: Нуждающийся не может самостоятельно зарегистрироваться. Создается только ведущим программы через админ-панель.

**Процесс создания ведущим программы:**
1. Ведущий программы в админ-панели создает нуждающегося
2. Указывает:
   - Телефон (для авторизации нуждающегося)
   - Имя и фамилию
   - Программу (привязка к программе)
   - Город (из списка)
   - Адрес (для поиска ближайших волонтеров)
3. Система отправляет SMS с кодом подтверждения
4. Нуждающийся авторизуется по телефону + SMS код (как волонтеры) и получает доступ к созданию тасок

#### 3.1.4 Регистрация ведущего программы
1. **Авторизация**: Email + Пароль (не телефон)
2. Первый админ регистрируется через админ-панель по email и паролю
3. Создание программы(м) с названием и описанием
4. Полный доступ к админ-панели для управления своими программами
5. Управление нуждающимися (создание, редактирование, удаление)
6. Может создавать таски от имени нуждающихся

---

### 3.2 Функционал волонтера

#### 3.2.1 Главный экран
- Список доступных тасок (показываются ближайшие таски по городу волонтера)
- Фильтрация по навыкам волонтера (показываются только подходящие по навыкам)
- Push-уведомления о новых тасках
- Карта с отображением тасок (опционально)
- **Примечание**: Пока радиус 50км не реализован, используется привязка к городу

#### 3.2.2 Просмотр таски
- Тип помощи
- Описание
- Адрес нуждающегося (без личных данных)
- Расстояние от волонтера
- Кнопка "Откликнуться"

#### 3.2.3 Отклик на таску
- Волонтер нажимает "Откликнуться"
- Нуждающийся получает уведомление
- Если включен режим "Первый отклик" - таска сразу назначается первому волонтеру
- Волонтер может отменить отклик (если таска еще не принята нуждающимся)
- После принятия нуждающимся волонтера статус таски меняется на "В обработке"

#### 3.2.4 Выполнение таски
- После одобрения нуждающимся, волонтер видит полную информацию о нуждающемся:
  - Телефон нуждающегося
  - Адрес нуждающегося
  - Дополнительная информация
- Кнопка "Выполнено" доступна и волонтеру, и нуждающемуся
- Для завершения таски необходимо подтверждение с обеих сторон (и волонтер, и нуждающийся должны нажать "Выполнено")
- После подтверждения обеими сторонами таска переходит в статус "Выполнена"
- Начисление баллов волонтеру (количество указано в таске)
- Таска исчезает из активных списков

#### 3.2.5 Профиль волонтера
- Фото
- Имя и фамилия
- Навыки
- Локация
- Информация о себе
- Статистика:
  - Количество выполненных тасок
  - Текущие баллы
  - Рейтинг
- История выполненных тасок

#### 3.2.6 Геймификация
- Баллы за каждую выполненную таску (количество указывается в таске при создании)
- Рейтинг волонтеров: средний рейтинг по отзывам (звездочки от 1 до 5)
- Обмен баллов на билеты происходит вне приложения
- Ведущий программы может списывать баллы у волонтеров через админ-панель

---

### 3.3 Функционал нуждающегося

#### 3.3.1 Создание таски
1. **AI помощник** (заглушка на первом этапе):
   - Нуждающийся вводит текстовый промпт с описанием проблемы (например: "Нужно забрать ребенка из садика")
   - AI на основе промпта:
     - Генерирует название и описание таски
     - Предлагает уточняющие вопросы для конкретизации задачи
     - Примеры вопросов:
       - "Во сколько нужно забрать ребенка?"
       - "Какой конкретно суп нужно сварить?"
       - "В какое время должна быть выполнена задача?"
   - Нуждающийся видит сгенерированную таску и список уточняющих вопросов
   - В одном текстовом поле "Дополнительная информация" нуждающийся может ответить на все предложенные вопросы
   - Можно повторно использовать AI для перегенерации таски
   - В будущем: голосовые сообщения для промпта
2. **Выбор типа помощи** из списка (после генерации AI):
   - Забрать ребенка из садика
   - Покупки/Доставка
   - Мелкий ремонт
   - Уборка
   - Помощь с переездом
   - Другое
   - Тип помощи можно изменить после генерации AI
3. **Указание количества баллов** за выполнение таски (можно задать, например, 10 баллов)
4. Редактирование сгенерированной таски (при необходимости)
5. Публикация таски
6. Push-уведомления подходящим волонтерам (по навыкам)

#### 3.3.2 Управление тасками
- Список созданных тасок
- Статусы: Активная, В обработке, Выполнена, Отменена
- Редактирование активных тасок
- Отмена тасок (может отменить нуждающийся или админ)
- Кнопка "Выполнено" для подтверждения выполнения таски (необходимо подтверждение и от волонтера)

#### 3.3.3 Просмотр откликов
- Список волонтеров, откликнувшихся на таску
- Информация о волонтере:
  - Фото
  - Имя и фамилия
  - Навыки
  - Рейтинг
  - Количество выполненных тасок
- Действия:
  - Одобрить (выбрать волонтера)
  - Отклонить

#### 3.3.4 Режим "Первый отклик"
- Опция включения/выключения
- При включении: первый откликнувшийся автоматически получает таску
- Остальные получают уведомление: "Спасибо за намерение, но кто-то взял таску быстрее"
- Нуждающийся может отменить назначение волонтера
- Волонтер может отменить назначенную ему таску

#### 3.3.5 Информация о волонтере
- После одобрения нуждающийся видит:
  - Полную информацию о волонтере
  - Контактные данные (если разрешено)
  - Историю выполненных тасок

#### 3.3.6 Отзывы
- После выполнения таски возможность оставить отзыв
- Рейтинг волонтера: звездочки от 1 до 5
- Текстовый комментарий
- Рейтинг влияет на средний рейтинг волонтера

---

### 3.4 Функционал ведущего программы (Админ)

#### 3.4.1 Управление программами
- Создание новых программ
- Редактирование программ
- Просмотр списка программ
- Переключение между программами в админ-панели

#### 3.4.2 Управление нуждающимися
- Создание нуждающихся в рамках программы
- Список всех нуждающихся в программе
- Редактирование данных нуждающихся:
  - Имя, фамилия
  - Телефон
  - Город
  - Адрес
- Удаление нуждающихся
- Просмотр профиля и истории тасок нуждающегося

#### 3.4.3 Управление волонтерами
- Список всех волонтеров в рамках программы
- Фильтры: статус (pending, approved, blocked), программа
- Действия:
  - Одобрить регистрацию (pending → approved)
  - Заблокировать
  - Удалить
  - Просмотр профиля

#### 3.4.4 Управление городами
- Добавление городов с указанием:
  - Название города
  - Широта (latitude)
  - Долгота (longitude)
- Редактирование координат городов
- Список всех городов
- Используется для привязки волонтеров и нуждающихся (без использования внешних API геолокации)

#### 3.4.5 Управление тасками
- Просмотр всех тасок в рамках программы
- Редактирование тасок (может редактировать при любом статусе)
- Создание тасок от имени нуждающихся
- Отмена тасок (может отменить нуждающийся или админ)
- Просмотр статистики по таскам

#### 3.4.6 Управление баллами
- Просмотр баланса баллов каждого волонтера в программе
- Списание баллов (при обмене на билеты)
- История операций с баллами

#### 3.4.7 Статистика и отчеты
- Общее количество волонтеров в программе
- Общее количество нуждающихся в программе
- Количество активных тасок
- Количество выполненных тасок
- Рейтинг волонтеров
- Географическое распределение по городам

---

## 4. Технические требования

### 4.1 Технологический стек

#### Backend
- **Framework**: Nest.js
- **Язык**: TypeScript
- **База данных**: PostgreSQL с расширением PostGIS для геолокации
- **ORM**: TypeORM
- **Аутентификация**: 
  - JWT + SMS сервис (Twilio, SMS.ru или аналогичный) для волонтеров и нуждающихся
  - JWT + Email/Password для админов (ведущих программ)
- **Push-уведомления**: Firebase Cloud Messaging (FCM) или Web Push API для PWA
- **Геолокация**: PostGIS для расчета расстояний и поиска в радиусе (без внешних API)
- **Структура модулей**: Каждый модуль содержит controller, service, module, dto/, entities/, types/ (при необходимости)

#### Frontend (PWA)
- **Framework**: React
- **Язык**: TypeScript
- **Архитектура**: Feature-Sliced Design (FSD)
- **PWA**: Service Worker, Web App Manifest
- **Роутинг**: React Router
- **State Management**: Redux Toolkit или Zustand
- **UI библиотека**: Material-UI, Ant Design или Tailwind CSS
- **Геолокация**: Используются координаты городов из базы данных (без внешних API)

#### Админ-панель
- **Framework**: React
- **Язык**: TypeScript
- **UI**: Админ-шаблон (Ant Design Pro, Material-UI Admin или аналогичный)
- **Роутинг**: React Router

### 4.2 PWA требования

#### 4.2.1 Push-уведомления
- Использование Web Push API
- Service Worker для обработки уведомлений
- Поддержка на iOS и Android через браузер
- Уведомления о:
  - Новых тасках (для волонтеров, подходящих по навыкам)
  - Откликах на таски (для нуждающихся)
  - Одобрении/отклонении (для волонтеров)
  - Изменении статуса таски
  - Отмене назначения таски

#### 4.2.2 Офлайн функциональность
- Кэширование списка тасок
- Возможность просмотра профиля офлайн
- Синхронизация при восстановлении соединения

#### 4.2.3 Установка приложения
- Popup с предложением установить PWA
- Иконка приложения
- Splash screen

---

## 5. Структура проекта

```
volonters/
├── backend/                 # Nest.js приложение
│   ├── src/
│   │   ├── app/            # Главный модуль приложения
│   │   │   ├── app.controller.ts
│   │   │   ├── app.module.ts
│   │   │   └── app.service.ts
│   │   ├── auth/           # Авторизация (SMS)
│   │   │   ├── auth.controller.ts
│   │   │   ├── auth.module.ts
│   │   │   ├── auth.service.ts
│   │   │   ├── dto/
│   │   │   ├── guards/
│   │   │   ├── strategies/
│   │   │   └── services/
│   │   ├── users/          # Пользователи (волонтеры, нуждающиеся, админы)
│   │   │   ├── user.controller.ts
│   │   │   ├── user.module.ts
│   │   │   ├── user.service.ts
│   │   │   ├── dto/
│   │   │   ├── entities/
│   │   │   └── types/
│   │   ├── programs/       # Программы
│   │   │   ├── program.controller.ts
│   │   │   ├── program.module.ts
│   │   │   ├── program.service.ts
│   │   │   ├── dto/
│   │   │   └── entities/
│   │   ├── cities/         # Города с координатами
│   │   │   ├── city.controller.ts
│   │   │   ├── city.module.ts
│   │   │   ├── city.service.ts
│   │   │   ├── dto/
│   │   │   └── entities/
│   │   ├── tasks/          # Таски
│   │   │   ├── task.controller.ts
│   │   │   ├── task.module.ts
│   │   │   ├── task.service.ts
│   │   │   ├── dto/
│   │   │   └── entities/
│   │   ├── ai-assistant/   # AI помощник для создания тасок
│   │   │   ├── ai-assistant.controller.ts
│   │   │   ├── ai-assistant.module.ts
│   │   │   ├── ai-assistant.service.ts
│   │   │   └── dto/
│   │   ├── skills/         # Навыки волонтеров
│   │   │   ├── skill.controller.ts
│   │   │   ├── skill.module.ts
│   │   │   ├── skill.service.ts
│   │   │   ├── dto/
│   │   │   └── entities/
│   │   ├── responses/      # Отклики на таски
│   │   │   ├── response.controller.ts
│   │   │   ├── response.module.ts
│   │   │   ├── response.service.ts
│   │   │   ├── dto/
│   │   │   └── entities/
│   │   ├── reviews/        # Отзывы
│   │   │   ├── review.controller.ts
│   │   │   ├── review.module.ts
│   │   │   ├── review.service.ts
│   │   │   ├── dto/
│   │   │   └── entities/
│   │   ├── points/         # Система баллов
│   │   │   ├── point.controller.ts
│   │   │   ├── point.module.ts
│   │   │   ├── point.service.ts
│   │   │   ├── dto/
│   │   │   └── entities/
│   │   ├── notifications/  # Push-уведомления
│   │   │   ├── notification.controller.ts
│   │   │   ├── notification.module.ts
│   │   │   ├── notification.service.ts
│   │   │   ├── dto/
│   │   │   └── entities/
│   │   ├── shared/         # Общие компоненты
│   │   │   ├── constants.ts
│   │   │   ├── decorators/
│   │   │   ├── guards/
│   │   │   └── pagination/
│   │   └── main.ts
│   └── test/
│
├── frontend/               # React PWA приложение (FSD архитектура)
│   ├── src/
│   │   ├── app/            # Инициализация приложения
│   │   │   ├── providers/
│   │   │   └── index.tsx
│   │   ├── pages/          # Страницы приложения
│   │   │   ├── auth/
│   │   │   ├── tasks/
│   │   │   ├── profile/
│   │   │   └── ...
│   │   ├── widgets/        # Виджеты (композиция features)
│   │   │   ├── task-list/
│   │   │   ├── volunteer-profile/
│   │   │   └── ...
│   │   ├── features/       # Бизнес-логика
│   │   │   ├── create-task/
│   │   │   ├── respond-to-task/
│   │   │   ├── approve-volunteer/
│   │   │   └── ...
│   │   ├── entities/       # Бизнес-сущности
│   │   │   ├── task/
│   │   │   ├── user/
│   │   │   ├── program/
│   │   │   └── ...
│   │   ├── shared/         # Переиспользуемые компоненты
│   │   │   ├── ui/         # UI компоненты
│   │   │   ├── lib/        # Утилиты
│   │   │   ├── api/        # API клиенты
│   │   │   └── config/     # Конфигурация
│   │   └── service-worker/ # Service Worker для PWA
│   └── public/
│       └── manifest.json   # PWA манифест
│
├── admin/                  # Админ-панель
│   ├── src/
│   │   ├── components/
│   │   ├── pages/
│   │   ├── services/
│   │   └── store/
│   └── public/
│
└── docs/                   # Документация
```

---

## 6. Основные сущности базы данных

### 6.1 Program (Программа)
```typescript
{
  id: string (UUID)
  name: string (название программы)
  description: string (описание)
  adminId: string (FK -> User, ведущий программы)
  isActive: boolean
  createdAt: Date
  updatedAt: Date
}
```

### 6.2 City (Город)
```typescript
{
  id: string (UUID)
  name: string (название города)
  latitude: number (широта)
  longitude: number (долгота)
  location: Point (PostGIS тип для геолокации)
  createdAt: Date
  updatedAt: Date
}
```

### 6.3 User (Пользователь)
```typescript
{
  id: string (UUID)
  phone: string | null (уникальный, для волонтеров и нуждающихся)
  email: string | null (уникальный, для админа)
  password: string (хэш, для админа)
  role: 'volunteer' | 'needy' | 'admin'
  status: 'pending' | 'approved' | 'blocked'
  firstName: string
  lastName: string
  photo: string (URL)
  about: string (текст)
  programId: string | null (FK -> Program, для волонтеров и нуждающихся)
  createdAt: Date
  updatedAt: Date
}
```

### 6.4 Volunteer (Волонтер) - расширение User
```typescript
{
  id: string (UUID)
  userId: string (FK -> User)
  programId: string (FK -> Program)
  cityId: string (FK -> City)
  skills: string[] (массив навыков)
  points: number (баллы, по программе)
  completedTasksCount: number (по программе)
  rating: number (средний рейтинг по отзывам, от 1 до 5, по программе)
  createdAt: Date
  updatedAt: Date
}
```

### 6.5 Needy (Нуждающийся) - расширение User
```typescript
{
  id: string (UUID)
  userId: string (FK -> User)
  programId: string (FK -> Program)
  cityId: string (FK -> City)
  address: string (адрес в городе)
  createdByAdminId: string (FK -> User, админ, который создал нуждающегося)
  createdAt: Date
  updatedAt: Date
}
```

### 6.6 Task (Таска)
```typescript
{
  id: string (UUID)
  programId: string (FK -> Program)
  needyId: string (FK -> User)
  type: string (тип помощи)
  title: string
  description: string
  details: string (нюансы и доп. информация, ответы на уточняющие вопросы)
  points: number (количество баллов за выполнение таски)
  status: 'active' | 'in_progress' | 'completed' | 'cancelled'
  cityId: string (FK -> City)
  address: string (адрес в городе)
  location: Point (PostGIS тип, координаты из города + адрес)
  firstResponseMode: boolean (режим первого отклика)
  assignedVolunteerId: string | null (FK -> User)
  completedByVolunteer: boolean (подтверждение выполнения волонтером)
  completedByNeedy: boolean (подтверждение выполнения нуждающимся)
  createdAt: Date
  updatedAt: Date
}
```

### 6.7 TaskResponse (Отклик на таску)
```typescript
{
  id: string (UUID)
  taskId: string (FK -> Task)
  volunteerId: string (FK -> User)
  programId: string (FK -> Program)
  status: 'pending' | 'approved' | 'rejected'
  createdAt: Date
}
```

### 6.8 Review (Отзыв)
```typescript
{
  id: string (UUID)
  taskId: string (FK -> Task)
  programId: string (FK -> Program)
  volunteerId: string (FK -> User)
  needyId: string (FK -> User)
  rating: number (1-5)
  comment: string
  createdAt: Date
}
```

### 6.9 PointsTransaction (Транзакция баллов)
```typescript
{
  id: string (UUID)
  volunteerId: string (FK -> User)
  programId: string (FK -> Program)
  amount: number (положительное - начисление, отрицательное - списание)
  type: 'earned' | 'redeemed' | 'admin_adjustment'
  taskId: string | null (FK -> Task, если за выполнение таски)
  adminId: string | null (FK -> User, если списание админом)
  description: string
  createdAt: Date
}
```

---

## 7. Основные API endpoints

### 7.1 Авторизация
```
POST /auth/send-code        # Отправка SMS кода (для волонтеров и нуждающихся)
POST /auth/verify-code      # Проверка кода и получение токена (для волонтеров и нуждающихся)
POST /auth/login            # Авторизация по email/password (для админа)
POST /auth/refresh          # Обновление токена
```

### 7.2 Программы
```
GET    /programs                    # Список программ (для админа - свои, для пользователей - доступные)
GET    /programs/:id                # Детали программы
POST   /programs                    # Создание программы (админ)
PUT    /programs/:id                # Редактирование программы (админ)
DELETE /programs/:id                # Удаление программы (админ)
```

### 7.3 Города
```
GET    /cities                      # Список всех городов
GET    /cities/:id                  # Детали города
POST   /cities                      # Добавление города (админ)
PUT    /cities/:id                  # Редактирование города (админ)
DELETE /cities/:id                  # Удаление города (админ)
```

### 7.4 Пользователи
```
GET  /users/me                      # Текущий пользователь
PUT  /users/me                      # Обновление профиля
POST /users/volunteer               # Регистрация волонтера (с указанием programId)
GET  /users/volunteers              # Список волонтеров в программе (для админа)
PUT  /users/volunteers/:id/approve  # Одобрить волонтера
PUT  /users/volunteers/:id/block    # Заблокировать волонтера
```

### 7.4.1 Управление нуждающимися (Админ)
```
GET    /admin/needy                 # Список нуждающихся в программе
GET    /admin/needy/:id              # Детали нуждающегося
POST   /admin/needy                  # Создание нуждающегося (админ)
PUT    /admin/needy/:id              # Редактирование нуждающегося (админ)
DELETE /admin/needy/:id              # Удаление нуждающегося (админ)
```

### 7.5 Таски
```
GET    /tasks                        # Список тасок в программе (фильтрация по навыкам, показываются ближайшие по городу)
GET    /tasks/:id                    # Детали таски
POST   /tasks                        # Создание таски (нуждающийся или админ от имени нуждающегося, в рамках программы)
PUT    /tasks/:id                    # Редактирование таски (нуждающийся или админ при любом статусе)
DELETE /tasks/:id                    # Удаление/отмена таски (нуждающийся или админ)
POST   /tasks/:id/respond            # Откликнуться на таску (волонтер)
DELETE /tasks/:id/respond            # Отменить отклик на таску (волонтер, если таска еще не принята)
POST   /tasks/:id/approve            # Одобрить волонтера (нуждающийся) - статус меняется на "В обработке"
POST   /tasks/:id/reject             # Отклонить волонтера (нуждающийся)
POST   /tasks/:id/cancel-assignment  # Отменить назначение волонтера (нуждающийся или волонтер)
POST   /tasks/:id/complete           # Подтвердить выполнение таски (волонтер или нуждающийся)
GET    /tasks/my                     # Мои таски (для нуждающегося)
GET    /tasks/assigned               # Назначенные таски (для волонтера)
```

### 7.5.1 AI помощник для создания тасок
```
POST   /tasks/ai/generate            # Генерация таски на основе промпта (возвращает название, описание, вопросы)
```

### 7.6 Отзывы
```
POST /reviews                        # Создать отзыв
GET  /reviews/volunteer/:id          # Отзывы о волонтере (в рамках программы)
```

### 7.7 Баллы
```
GET  /points/balance                 # Баланс баллов (волонтер, по программе)
GET  /points/history                 # История транзакций (по программе)
POST /points/redeem                  # Обмен баллов (через админа)
POST /admin/points/:id/deduct       # Списание баллов (админ, в рамках программы)
```

### 7.8 Админ
```
GET  /admin/statistics               # Статистика по программе
GET  /admin/tasks                    # Все таски в программе
PUT  /admin/tasks/:id                # Редактирование таски админом
GET  /admin/volunteers               # Все волонтеры в программе
GET  /admin/cities                   # Управление городами
POST /admin/cities                   # Добавление города
PUT  /admin/cities/:id               # Редактирование города
```

### 7.9 Уведомления
```
POST /notifications/subscribe       # Подписка на push-уведомления
GET  /notifications                 # Список уведомлений
PUT  /notifications/:id/read        # Отметить как прочитанное
```

---

## 8. План разработки (Этапы)

### Этап 1: Базовая инфраструктура (1-2 недели)
- [ ] Настройка проекта (backend, frontend, admin)
- [ ] Настройка базы данных
- [ ] Базовая структура Nest.js
- [ ] Базовая структура React приложений
- [ ] Настройка TypeScript и линтеров

### Этап 2: Авторизация и пользователи (1-2 недели)
- [ ] Интеграция SMS сервиса (для волонтеров и нуждающихся)
- [ ] Реализация авторизации по телефону (SMS код)
- [ ] Реализация авторизации по email/password (для админа)
- [ ] JWT токены
- [ ] Модели пользователей в БД (с поддержкой phone и email)
- [ ] API для регистрации волонтера и авторизации
- [ ] API для авторизации админа
- [ ] UI для авторизации в PWA

### Этап 3: Программы и города (1 неделя)
- [ ] Модель Program в БД
- [ ] Модель City в БД с PostGIS
- [ ] API для управления программами (админ)
- [ ] API для управления городами (админ)
- [ ] UI для управления программами и городами в админке

### Этап 4: Профили и онбординг (1-2 недели)
- [ ] Онбординг волонтера (выбор программы, навыки, выбор города)
- [ ] Профиль волонтера
- [ ] API для создания нуждающихся (админ)
- [ ] Профиль нуждающегося
- [ ] Загрузка фотографий
- [ ] Привязка к программе и городу
- [ ] UI для управления нуждающимися в админке

### Этап 5: Таски - базовый функционал (2-3 недели)
- [ ] Модель тасок в БД с привязкой к программе и городу
- [ ] Добавление поля points (количество баллов) в модель Task
- [ ] Добавление полей completedByVolunteer и completedByNeedy для подтверждения выполнения
- [ ] API для создания тасок (нуждающийся или админ от имени нуждающегося, в рамках программы)
- [ ] API для просмотра тасок
- [ ] Фильтрация по навыкам (показываются подходящие по навыкам, ближайшие по городу)
- [ ] **Примечание**: Радиус 50км пока не реализуется, используется привязка к городу
- [ ] AI помощник для генерации тасок:
  - API endpoint для генерации таски на основе промпта
  - Генерация названия, описания и уточняющих вопросов
  - Возможность повторной генерации
  - Заглушка на первом этапе (можно использовать OpenAI API или простой шаблон)
- [ ] UI для создания тасок (нуждающийся):
  - Ввод промпта (первый шаг)
  - Отображение сгенерированной таски
  - Отображение уточняющих вопросов
  - Одно текстовое поле для ответов на все вопросы
  - Выбор типа помощи (после генерации)
  - Указание количества баллов за выполнение
  - Возможность изменения типа помощи после генерации
  - Возможность повторной генерации
- [ ] UI для просмотра тасок (волонтер)

### Этап 6: Отклики и назначение (1-2 недели)
- [ ] Модель откликов в БД
- [ ] API для отклика на таску
- [ ] API для отмены отклика (волонтер)
- [ ] Режим "первый отклик" (автоматическое назначение)
- [ ] API для отмены назначения (нуждающийся или волонтер)
- [ ] Просмотр откликов (нуждающийся)
- [ ] Одобрение/отклонение волонтеров (статус меняется на "В обработке" после одобрения)
- [ ] UI для управления откликами
- [ ] Отображение контактных данных (телефон и адрес нуждающегося) после одобрения

### Этап 7: Выполнение тасок и отзывы (1 неделя)
- [ ] Завершение тасок:
  - Кнопка "Выполнено" для волонтера и нуждающегося
  - Подтверждение выполнения с обеих сторон (completedByVolunteer и completedByNeedy)
  - Статус меняется на "Выполнена" только после подтверждения обеими сторонами
  - Начисление баллов волонтеру (количество из поля points таски)
- [ ] Система отзывов:
  - Рейтинг от 1 до 5 звезд
  - Текстовый комментарий
- [ ] Расчет среднего рейтинга волонтеров (по отзывам, от 1 до 5)
- [ ] UI для отзывов

### Этап 8: Система баллов и геймификация (1-2 недели)
- [ ] Модель транзакций баллов
- [ ] Начисление баллов за выполнение (количество из таски)
- [ ] Рейтинг волонтеров (средний рейтинг по отзывам, от 1 до 5)
- [ ] API для списания баллов (админ, вне приложения)
- [ ] UI для отображения баллов и рейтинга

### Этап 9: Push-уведомления (1-2 недели)
- [ ] Настройка Web Push API
- [ ] Service Worker для PWA
- [ ] Уведомления о новых тасках (только для волонтеров, подходящих по навыкам)
- [ ] Уведомления об откликах (для нуждающихся)
- [ ] Уведомления об одобрении/отклонении (для волонтеров)
- [ ] Уведомления об отмене назначения
- [ ] Тестирование на iOS и Android

### Этап 10: Админ-панель (2-3 недели)
- [ ] Управление программами (создание, редактирование)
- [ ] Управление городами (добавление, редактирование координат)
- [ ] Управление нуждающимися (создание, редактирование, удаление)
- [ ] Управление волонтерами (одобрение, блокировка) в рамках программы
- [ ] Управление тасками в рамках программы:
  - Просмотр всех тасок
  - Редактирование тасок при любом статусе
  - Создание тасок от имени нуждающихся
  - Отмена тасок
- [ ] Управление баллами (списание баллов у волонтеров)
- [ ] Статистика и отчеты по программам
- [ ] UI админ-панели

### Этап 11: PWA оптимизация (1 неделя)
- [ ] Service Worker для офлайн режима
- [ ] Кэширование данных
- [ ] Манифест приложения
- [ ] Иконки и splash screen
- [ ] Popup для установки PWA

### Этап 12: Тестирование и доработки (1-2 недели)
- [ ] Unit тесты (backend)
- [ ] Интеграционные тесты
- [ ] E2E тесты (опционально)
- [ ] Исправление багов
- [ ] Оптимизация производительности

### Этап 13: Деплой и документация (1 неделя)
- [ ] Настройка CI/CD
- [ ] Деплой backend
- [ ] Деплой frontend PWA
- [ ] Деплой админ-панели
- [ ] Документация API
- [ ] Инструкции по развертыванию

---

## 9. Дополнительные требования

### 9.1 Безопасность
- Валидация всех входных данных
- Защита от SQL инъекций
- Rate limiting для API
- HTTPS обязателен
- Защита персональных данных (GDPR compliance)

### 9.2 Производительность
- Кэширование часто запрашиваемых данных
- Пагинация для списков
- Оптимизация запросов к БД
- Lazy loading для изображений

### 9.3 UX/UI
- Адаптивный дизайн (mobile-first)
- Интуитивный интерфейс
- Быстрая загрузка
- Понятные сообщения об ошибках

### 9.4 Масштабируемость
- Возможность добавления новых типов помощи
- Расширяемая система навыков
- Гибкая система баллов (для будущих изменений)

---

## 10. Будущие улучшения (не в MVP)

- [ ] Голосовые сообщения для AI помощника
- [ ] Временные ограничения для тасок
- [ ] Чат между волонтером и нуждающимся
- [ ] История сообщений
- [ ] Расширенная аналитика
- [ ] Мобильные приложения (iOS/Android native)
- [ ] Интеграция с картами для навигации
- [ ] Мультиязычность

---

## 11. Вопросы для уточнения

1. **SMS провайдер**: Какой сервис использовать для отправки SMS? (Twilio, SMS.ru, другие)
2. **Хостинг**: Где планируется размещение (AWS, VPS, другие)? Нужна поддержка PostGIS
3. **Домен**: Есть ли уже доменное имя?
4. **Бюджет**: Ограничения по использованию платных сервисов?
5. **Модерация**: Нужна ли модерация тасок перед публикацией?
6. **Лимиты**: Ограничения на количество тасок от одного нуждающегося?
7. **Программы**: Максимальное количество программ у одного ведущего?
8. **Города**: Начальный список городов для добавления в систему?
9. **AI сервис**: Какой AI сервис использовать для генерации тасок? (OpenAI API, локальная модель, заглушка на первом этапе)

---

## 12. Контакты и коммуникация

- Репозиторий: [указать после создания]
- Документация API: [будет создана на этапе 12]
- Trello/Jira: [если используется]

---

**Версия документа**: 2.2  
**Дата создания**: [текущая дата]  
**Последнее обновление**: [текущая дата]

## 13. Ключевые изменения в версии 2.2

### Архитектурные изменения:
1. **Программы (Programs)**: Все действия происходят в рамках программы. Ведущий программы может создавать несколько программ.
2. **Города (Cities)**: Управление городами через админ-панель с указанием координат вручную (без внешних API).
3. **PostGIS**: Использование PostGIS для геолокации и расчета расстояний вместо внешних API.
4. **Backend структура**: Модульная структура Nest.js как в backend-pol (controller, service, module, dto, entities).
5. **Frontend структура**: Feature-Sliced Design (FSD) архитектура для PWA приложения.

### Изменения в данных:
- Все сущности привязаны к программе (programId)
- Волонтеры и нуждающиеся привязаны к городу (cityId)
- Баллы и рейтинги считаются в рамках программы
- Геолокация через PostGIS Point тип

### Изменения в версии 2.1:
1. **Нуждающиеся**: Создаются только ведущим программы через админ-панель, не могут самостоятельно регистрироваться
2. **Авторизация админа**: Email + Password вместо телефона
3. **AI помощник**: Генерирует таску на основе промпта и предлагает уточняющие вопросы, нуждающийся отвечает на них в текстовом поле
4. **Управление нуждающимися**: Добавлен функционал создания, редактирования и удаления нуждающихся в админ-панели

### Изменения в версии 2.2 (Уточнения флоу):
1. **Авторизация нуждающегося**: По телефону + SMS код (как волонтеры), после создания админом
2. **Создание таски**: 
   - Сначала ввод промпта для AI, затем выбор типа помощи
   - Одно текстовое поле для ответов на все уточняющие вопросы
   - Можно изменить тип помощи и повторно использовать AI для генерации
   - В таске указывается количество баллов за выполнение
3. **Выполнение таски**: 
   - Кнопка "Выполнено" у обоих (волонтер и нуждающийся)
   - Необходимо подтверждение с обеих сторон для завершения
   - После одобрения волонтер видит телефон и адрес нуждающегося
4. **Отклики и назначение**:
   - Статус "В обработке" только после принятия нуждающимся волонтера
   - Волонтер может отменить отклик до принятия
   - Нуждающийся и волонтер могут отменить назначение
5. **Рейтинг**: Средний рейтинг по отзывам (звездочки от 1 до 5), не по количеству тасок
6. **Баллы**: Количество указывается в таске при создании, админ может списывать баллы
7. **Геолокация**: Пока используется привязка к городу, радиус 50км не реализуется
8. **Фильтрация тасок**: По навыкам (подходящие по навыкам, ближайшие по городу)
9. **Админ-панель**: 
   - Админ может создавать таски от имени нуждающихся
   - Админ может редактировать таски при любом статусе
   - Первый админ регистрируется через админ-панель
10. **Отмена тасок**: Может отменить нуждающийся или админ
